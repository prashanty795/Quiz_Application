{% extends 'staff/staffbase.html' %}
{% block content %}
{% load static %}

<head>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
</head>

<!-- Display the timer -->
<div id="timer" class="text-center"></div>

<div class="jumbotron my-4">
  <form id="quizForm" class="form" autocomplete="off" action="/staff/calculate-marks" method="POST">
    {% csrf_token %}
    <h1 style="text-align: center;">{{ course.course_name }}</h1>
    <div class="question-container">
      {% for q in questions %}
      <div class="question {% if forloop.first %}active{% else %}hidden{% endif %}" data-qid="{{ forloop.counter }}">
        <h3 class="text-info">{{ forloop.counter }}. {{ q.question }}</h3>
        <h4 style="text-align: right;">[Marks {{ q.marks }}]</h4>

        <input type="hidden" name="csrfmiddlewaretoken"
          value="C24rUotmdHawVQJL3KrqiWxvti8UffOFYUc8TRbZtLt36AVLdP3jbkzUVe3beRAa">

        <div class="form-check mx-4">
          <input class="form-check-input" type="radio" name="answer_{{ forloop.counter }}" id="{{ q.option1 }}"
            value="Option1">
          <label class="form-check-label" for="option1">{{ q.option1 }}</label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input" type="radio" name="answer_{{ forloop.counter }}" id="{{ q.option2 }}"
            value="Option2">
          <label class="form-check-label" for="option2">{{ q.option2 }}</label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input" type="radio" name="answer_{{ forloop.counter }}" id="{{ q.option3 }}"
            value="Option3">
          <label class="form-check-label" for="option3">{{ q.option3 }}</label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input" type="radio" name="answer_{{ forloop.counter }}" id="{{ q.option4 }}"
            value="Option4">
          <label class="form-check-label" for="option4">{{ q.option4 }}</label>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="text-center">
      <button type="button" id="nextBtn" class="btn btn-info btn-lg">Next</button>
      <button type="submit" id="submitBtn" class="btn btn-success btn-lg hidden">Submit</button>
    </div>
  </form>
</div>

<script>
var remainingTime = {{ remaining_time }} * 60;
var currentQuestion = 1;
var totalQuestions = {{ questions|length }};

function updateTimer() {
  var hours = Math.floor(remainingTime / 3600);
  var minutes = Math.floor((remainingTime % 3600) / 60);
  var seconds = remainingTime % 60;

  var timerDisplay = document.getElementById('timer');
  timerDisplay.textContent = 'Time Remaining: ' + pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
  remainingTime--;

  if (remainingTime < 0 || currentQuestion > totalQuestions) {
    document.getElementById('quizForm').submit();
  }
}

setInterval(updateTimer, 1000);

function pad(num) {
  return (num < 10 ? '0' : '') + num;
}

function saveAns() {
  var ele = document.querySelector('.question.active').querySelector('input[type=radio]:checked');
  if (ele) {
    var questionId = ele.name.split('_')[1];
    setCookie('q_' + questionId, ele.value, 3);
  }
}

function setCookie(cname, cvalue, exdays) {
  var d = new Date();
  d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
  var expires = "expires=" + d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function showNextQuestion() {
  saveAns();

  var currentQuestionDiv = document.querySelector('.question.active');
  currentQuestionDiv.classList.remove('active');
  currentQuestionDiv.classList.add('hidden');

  currentQuestion++;
  if (currentQuestion >= totalQuestions) {
    var nextQuestionDiv = document.querySelector('.question[data-qid="' + currentQuestion + '"]');
    nextQuestionDiv.classList.remove('hidden');
    nextQuestionDiv.classList.add('active');

    document.getElementById('nextBtn').classList.add('hidden');
    document.getElementById('submitBtn').classList.remove('hidden');
  } else {
    var nextQuestionDiv = document.querySelector('.question[data-qid="' + currentQuestion + '"]');
    nextQuestionDiv.classList.remove('hidden');
    nextQuestionDiv.classList.add('active');
  }
}

document.getElementById('nextBtn').addEventListener('click', showNextQuestion);

window.addEventListener('beforeunload', function (e) {
  if (!document.getElementById('submitBtn').classList.contains('hidden') || remainingTime <= 0) {
    return; // Allow submission without confirmation message when submitting or when time is up
  }
  var confirmationMessage = 'Are you sure you want to leave? Your progress will be lost.';
  (e || window.event).returnValue = confirmationMessage;
  return confirmationMessage;
});

function clearAnswers() {
  var questions = document.querySelectorAll('.question');
  questions.forEach(function(question) {
    var questionId = question.dataset.qid;
    document.cookie = 'q_' + questionId + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
  });
}

window.onload = clearAnswers;

</script>

<br><br><br><br><br><br>
{% endblock content %}
